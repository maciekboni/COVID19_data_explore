---
title: "COVID19 data exploration"
author: "Vincent L. Cannataro"
date: 'last update `r format(Sys.Date(), "%Y-%B-%d")`'
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```


Data obtained from curated Johns Hopkins University Center for Systems Science and Engineering database here: https://github.com/CSSEGISandData/COVID-19.git


```{r get data, include=F}
jhu_data <- read.csv(check.names = F,
  file = "JHU_COVID19_data/COVID-19/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv")

# clean data types prior to melting
jhu_data <- jhu_data %>%
  mutate_if(is.numeric,as.character, 
            is.factor, as.character)

jhu_data_m <- tidyr::pivot_longer(data = jhu_data, 
                                  cols=`1/22/20`:colnames(jhu_data)[ncol(jhu_data)], 
                                  values_to = "Confirmed_cases",names_to = "Date") %>%
  mutate(Confirmed_cases = as.numeric(Confirmed_cases))

jhu_data_m <- jhu_data_m %>%
  mutate(Date = as.Date(Date, format= "%m/%d/%y"))



```

# Current USA confirmed cases


```{r USA data, include=F}


US_data <- jhu_data_m %>% 
  filter(`Country/Region` %in% c("US")) %>%
  group_by(`Country/Region`,Date) %>%
  summarize(all_cases = sum(Confirmed_cases)) %>%
  filter(!is.na(all_cases)) 

```




It looks like the total number of confirmed cases in the USA is currently growing exponentially. 

```{r,echo=F}
ggplot(data = US_data) + 
  geom_point(aes(x=Date, y=all_cases,color=`Country/Region`)) + 
  theme_classic()  + 
  labs(y="All confirmed cases") + 
  labs(title="Confirmed cases in the USA",
       caption = "Data: https://github.com/CSSEGISandData/COVID-19\nPlot: @VinCannataro") 

ggplot(data = US_data) + 
  geom_point(aes(x=Date, y=all_cases,color=`Country/Region`)) + 
  theme_classic()  + 
  labs(y="All confirmed cases, log10 scale") + 
  labs(title="Confirmed cases in the USA, Y axis log10 scaled",caption = "Data: https://github.com/CSSEGISandData/COVID-19\nPlot: @VinCannataro") + 
  scale_y_log10()
```

```{r, include=F}

start_date <- as.Date(x = "03/01/2020",format= "%m/%d/%y")

end_date <- as.Date(x = "04/12/2020",format= "%m/%d/%y")

```



Indeed, if we pull out the data from `r start_date` until the current date, and 
fit a linear model to the log10(y) ~ x, 

```{r exp fit}
start_date

fit_lm_exp <- lm(formula = log10(all_cases) ~ Date, 
                 data = subset(US_data,Date>start_date))

# summary(fit_lm_exp)$r.squared # removed r.squared because 
# it is not a correct statistic on this time series data 
# https://twitter.com/vsbuffalo/status/1239233074203746304 

```

<!-- We find an $R^2$ value of `r round(summary(fit_lm_exp)$r.squared,4)` -->

# Fitting into the future, assuming* exponential growth continues

\* of course, exponential growth never continues indefinitely in population models. 
Eventually, you will either run out of new susceptible people to infect. Or, 
we can intervene in disease spread, and deviate from this continued growth. 

But, let's assume exponential growth continues. What would happen to the number of 
confirmed cases over time?

We can use our fit to the recent data generated above to predict into the future.

```{r future fit}
end_date

# fitting into the future 
future_predictions <- data.frame(Date = seq(start_date,end_date,by = "1 day"))

future_predictions$log10_count <- predict(fit_lm_exp,newdata = future_predictions)

```


```{r fitting into the future plot, echo=F}

ggplot(data = US_data) + 
  geom_point(aes(x=Date, y=log10(all_cases),color=`Country/Region`)) + 
  geom_line(data = future_predictions, aes(x=Date,y=log10_count),linetype="dashed") + 
  theme_classic()  + 
  labs(y="log10(All confirmed cases)") + 
  scale_x_date(date_breaks = "2 days",date_labels = "%b %d") + 
  theme(axis.text.x = element_text(angle=90)) + 
  labs(title="Confirmed cases in the USA, including a simple prediction",
       caption = "Data: https://github.com/CSSEGISandData/COVID-19\nPlot: @VinCannataro")
```


Keep in mind, that the axis above is on a log10 scale, meaning that $6$ on the axis
is really $1000000$

*Let's do everything we can do deviate from this fit!*


```{r, include=F}
fit_plot <- ggplot(data = US_data) + 
  geom_point(aes(x=Date, y=log10(all_cases),color=`Country/Region`)) + 
  geom_line(data = future_predictions, aes(x=Date,y=log10_count),linetype="dashed") + 
  theme_classic()  + 
  labs(y="log10(All confirmed cases)") + 
  scale_x_date(date_breaks = "2 days",date_labels = "%b %d") + 
  theme(axis.text.x = element_text(angle=90)) + 
  labs(title="Confirmed cases in the USA, including a simple prediction")

ggplot2::ggsave(plot = fit_plot,
                filename = "output_data/figures/fit_plot.pdf",width = 7,height = 5)

```




# By State

```{r breaking up USA by state, include=F}
# just the USA data 
USA_by_state <- jhu_data_m %>%
  filter(`Country/Region` == "US")


# need to collapse county level to the state level
state_names <- data.frame(state_name = state.name, state_abb = state.abb,stringsAsFactors = F)
state_names <- rbind(state_names,c("D.C.","D.C."))
rownames(state_names) <- state_names$state_abb


# grep(pattern = paste(state.abb,collapse = "|"),x = USA_by_state$`Province/State`,)

state_vec <- rep(NA,length=nrow(USA_by_state))

state_split <- strsplit(x = as.character(USA_by_state$`Province/State`),split = ",")

# loop through to bring county --> state level 
for(state_ind in 1:length(state_split)){
 if(length(state_split[[state_ind]])==1){
   state_vec[state_ind] <- state_split[[state_ind]]
 }else{
   state_vec[state_ind] <- state_names[trimws(state_split[[state_ind]][2]),"state_name"]
 }
}


USA_by_state$state <- state_vec 

USA_by_state <- USA_by_state %>%
  filter(state %in% state_names$state_name)

USA_by_state$state <- factor(USA_by_state$state, 
                                        levels=sort(unique(USA_by_state$state)))

USA_by_state <- USA_by_state %>%
  group_by(state, Date) %>%
  summarize(Confirmed_cases = sum(Confirmed_cases))
# ggplot(data = USA_by_state, aes(x = Date,y=Confirmed_cases,color=`Province/State`)) + 
#   geom_line() 

# this seems like what we want. 

```



```{r resetting data to start at first case, include=F}

first_cases <- USA_by_state %>% 
  filter(Confirmed_cases > 0) %>%
  group_by(state) %>% 
  summarize(first_case = min(Date)) %>%
  as.data.frame(., stringsAsFacter=F)
rownames(first_cases) <- first_cases$state

USA_by_state$Date_since_first_case <- USA_by_state$Date - first_cases[as.character(USA_by_state$state), "first_case"]

USA_by_state <- USA_by_state %>%
  filter(Date_since_first_case > 0)

```




```{r plotting states,echo=F,warning=F,fig.height=7,fig.width=12}

ggplot(data = USA_by_state, aes(x=as.numeric(Date_since_first_case), 
                                y= Confirmed_cases, 
                                color=state,
                                shape=state)) + 
  geom_line(alpha=0.5) + 
  geom_point(alpha=0.5) + 
  theme_classic() + 
  scale_color_discrete(name="State") + 
  scale_shape_manual(name="State",
                       labels=levels(USA_by_state$state),
                       values=c(rep(15:19,11),15,16)) + 
  labs(title="Confirmed cases in the USA, split by state",
       caption = "Data: https://github.com/CSSEGISandData/COVID-19\nPlot: @VinCannataro",
       y="Confirmed cases", 
       x="Days since first case in dataset ") + 
  # scale_y_log10() +
  scale_x_continuous(breaks = seq(from = 0,to = max(as.numeric(USA_by_state$Date_since_first_case)),by = 2))




ggplot(data = USA_by_state, aes(x=as.numeric(Date_since_first_case), 
                                y= Confirmed_cases, 
                                color=state,
                                shape=state)) + 
  geom_line(alpha=0.5) + 
  geom_point(alpha=0.5) + 
  theme_classic() + 
  scale_color_discrete(name="State") + 
  scale_shape_manual(name="State",
                       labels=levels(USA_by_state$state),
                       values=c(rep(15:19,11),15,16)) + 
  labs(title="Confirmed cases in the USA, split by state",
       caption = "Data: https://github.com/CSSEGISandData/COVID-19\nPlot: @VinCannataro",
       y="Confirmed cases, log10 axis scale", 
       x="Days since first case in dataset ") + 
  scale_y_log10() +
  scale_x_continuous(breaks = seq(from = 0,to = max(as.numeric(USA_by_state$Date_since_first_case)),by = 2))




```





## Table of confirmed cases in the USA: 
The total number of confirmed cases in the USA by date: 

```{r, echo=F}
knitr::kable(US_data)
```

